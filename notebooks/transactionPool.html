<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>transactionPool</title>
  
  
  
  
  <meta property="og:title" content="transactionPool" />
  <meta property="og:url" content="https://ethereum.github.io//" />
  <meta property="og:image" content="https://ethereum.github.io/rig/static/rig.png" />
  <meta property="og:description" content="" />
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="transactionPool">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="https://ethereum.github.io/rig/static/rig.png">

  <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.1/underscore-umd-min.js" type="text/javascript"></script>
  <script src="https://ethereum.github.io/rig/static/react.development.js"></script>
  <script src="https://ethereum.github.io/rig/static/react-dom.development.js"></script>
  <script src="https://ethereum.github.io/rig/static/component-library.js"></script>
  <script src="https://ethereum.github.io/rig/static/header.js"></script>
  <script src="https://ethereum.github.io/rig/static/footer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>





<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
  </style>



<link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/jupyter.css"/>
<link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/theme-light.css"/>
<style type="text/css">
a.anchor-link {
   display: none;
}
.highlight  {
    margin: 0.4em;
}

/* Input area styling */
.jp-InputArea {
    overflow: hidden;
}

.jp-InputArea-editor {
    overflow: hidden;
}

@media print {
  body {
    margin: 0;
  }
}
</style>


<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: { 
                    automatic: true 
                    }
                },
                "HTML-CSS": {
                    linebreaks: { 
                    automatic: true 
                    }
                }
            });
        
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration -->
  <link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/index.css"/>
</head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">

  <div id="header"></div>
  <script>
    ReactDOM.render(
      e(Header, null),
      document.querySelector("#header")
    );
    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector(".nav-menu");

    function mobileMenu() {
        hamburger.classList.toggle("active");
        navMenu.classList.toggle("active");
    }

    function closeMenu() {
        hamburger.classList.remove("active");
        navMenu.classList.remove("active");
    }

    hamburger.addEventListener("click", mobileMenu);

    const navLink = document.querySelectorAll(".nav-link");

    navLink.forEach(n => n.addEventListener("click", closeMenu));
  </script>
  <div class="article-container">
    <div class="document-container">
      <div class="title-container">
        <div class="title">
          Dynamical Analysis of the EIP-1559 Ethereum Fee Market
        </div>

        <div class="sub-title">
          
        </div>
      </div>

      <div id="toc-author-block">
        <div id="authors"></div>
        <div id="toc"></div>
      </div>
      <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 1 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = &#39;svg&#39;

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">abm1559.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">constants</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">gamma</span> <span class="o">=</span> <span class="mi">76000</span> <span class="c1"># obtained from stats analysis of sample txs</span>
<span class="n">constants</span><span class="p">[</span><span class="s2">&quot;SIMPLE_TRANSACTION_GAS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span>

<span class="kn">from</span> <span class="nn">abm1559.txpool</span> <span class="kn">import</span> <span class="n">TxPool</span>

<span class="kn">from</span> <span class="nn">abm1559.users</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">User1559</span><span class="p">,</span>
    <span class="n">User</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">abm1559.config</span> <span class="kn">import</span> <span class="n">rng</span>

<span class="kn">from</span> <span class="nn">abm1559.txs</span> <span class="kn">import</span> <span class="n">Tx1559</span>

<span class="kn">from</span> <span class="nn">abm1559.userpool</span> <span class="kn">import</span> <span class="n">UserPool</span>

<span class="kn">from</span> <span class="nn">abm1559.chain</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Chain</span><span class="p">,</span>
    <span class="n">Block1559</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">abm1559.simulator</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">spawn_poisson_heterogeneous_demand</span><span class="p">,</span>
    <span class="n">update_basefee</span><span class="p">,</span>
    <span class="n">generate_gbm</span><span class="p">,</span>
    <span class="n">apply_block_time_variance</span><span class="p">,</span>
    <span class="n">generate_poisson_process</span><span class="p">,</span>
    <span class="n">generate_abm</span><span class="p">,</span>
    <span class="n">generate_jump_process</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 2 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">MAX_TX_POOL</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">MIN_PREMIUM</span> <span class="o">=</span> <span class="mf">1e9</span>

<span class="k">class</span> <span class="nc">TxPool1559</span><span class="p">(</span><span class="n">TxPool</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_txs</span><span class="o">=</span><span class="n">MAX_TX_POOL</span><span class="p">,</span> <span class="n">min_premium</span><span class="o">=</span><span class="n">MIN_PREMIUM</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_txs</span> <span class="o">=</span> <span class="n">max_txs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_premium</span> <span class="o">=</span> <span class="n">MIN_PREMIUM</span>
    
    <span class="k">def</span> <span class="nf">add_txs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">txs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">txs</span><span class="p">[</span><span class="n">tx</span><span class="o">.</span><span class="n">tx_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx</span>
                    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_txs</span><span class="p">:</span>
            <span class="n">sorted_txs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">txs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tx</span><span class="p">:</span> <span class="o">-</span><span class="n">tx</span><span class="o">.</span><span class="n">tip</span><span class="p">(</span><span class="n">env</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empty_pool</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_txs</span><span class="p">(</span><span class="n">sorted_txs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_txs</span><span class="p">],</span> <span class="n">env</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sorted_txs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_txs</span><span class="p">:]</span>
        
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">select_transactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">user_pool</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">]:</span>
        <span class="c1"># Miner side</span>
        <span class="n">max_tx_in_block</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s2">&quot;MAX_GAS_EIP1559&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="p">[</span><span class="s2">&quot;SIMPLE_TRANSACTION_GAS&quot;</span><span class="p">])</span>

        <span class="n">valid_txs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tx</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">txs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">tx</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tx</span><span class="o">.</span><span class="n">tip</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_premium</span><span class="p">]</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">valid_txs</span><span class="p">)</span>

        <span class="n">sorted_valid_demand</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">valid_txs</span><span class="p">,</span>
            <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tx</span><span class="p">:</span> <span class="o">-</span><span class="n">tx</span><span class="o">.</span><span class="n">tip</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">selected_txs</span> <span class="o">=</span> <span class="n">sorted_valid_demand</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">max_tx_in_block</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">selected_txs</span>
    
<span class="k">class</span> <span class="nc">TxPoolTrendPicker</span><span class="p">(</span><span class="n">TxPool1559</span><span class="p">):</span>
    
    <span class="c1"># window = 1 &lt;=&gt; Fixed band policy</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">band_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band_width</span> <span class="o">=</span> <span class="n">band_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
        
    <span class="k">def</span> <span class="nf">should_evict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="n">Tx1559</span><span class="p">,</span> <span class="n">basefee</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># band_width = 1 &lt;=&gt; never evict</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">band_width</span><span class="p">)</span> <span class="o">*</span> <span class="n">basefee</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="o">.</span><span class="n">max_fee</span>
    
    <span class="k">def</span> <span class="nf">apply_eviction_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">],</span> <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">]]:</span>
        <span class="n">current_basefee</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">moving_average</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">([</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">][</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_basefee</span> <span class="o">-</span> <span class="n">moving_average</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_basefee</span>
        <span class="n">evicted_txs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tx</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">txs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_evict</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">current_basefee</span><span class="p">,</span> <span class="n">delta</span><span class="p">)]</span>
        <span class="n">accepted_txs</span> <span class="o">=</span> <span class="p">[</span><span class="n">tx</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">txs</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_evict</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">current_basefee</span><span class="p">,</span> <span class="n">delta</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">evicted_txs</span><span class="p">,</span> <span class="n">accepted_txs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">purge_pool_after_basefee_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tx1559</span><span class="p">]:</span>
        <span class="n">evicted_txs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_eviction_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">txs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_txs</span><span class="p">([</span><span class="n">tx</span><span class="o">.</span><span class="n">tx_hash</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">evicted_txs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">evicted_txs</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 3 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">StrategicUser</span><span class="p">(</span><span class="n">User1559</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wakeup_block</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">wakeup_block</span><span class="p">,</span> <span class="n">cost_per_unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="c1">#         self.value = (1 + self.rng.pareto(2) * 20) * 1e9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>

    <span class="k">def</span> <span class="nf">decide_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="c1"># If previous block was close to full, consider being strategic</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;wallet_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;posted&quot;</span><span class="p">:</span>
            <span class="n">gas_premium</span> <span class="o">=</span> <span class="n">MIN_PREMIUM</span>
            <span class="n">max_fee</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MIN_PREMIUM</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_fee</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">MIN_PREMIUM</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">gas_premium</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_fee</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_avg_tip&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MIN_PREMIUM</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;max_fee&quot;</span><span class="p">:</span> <span class="n">max_fee</span><span class="p">,</span> <span class="c1"># in wei</span>
            <span class="s2">&quot;gas_premium&quot;</span><span class="p">:</span> <span class="n">gas_premium</span><span class="p">,</span> <span class="c1"># in wei</span>
            <span class="s2">&quot;start_block&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wakeup_block</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">create_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        
        <span class="n">tx_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decide_parameters</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="n">tx</span> <span class="o">=</span> <span class="n">Tx1559</span><span class="p">(</span>
            <span class="n">sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_key</span><span class="p">,</span>
            <span class="n">tx_params</span> <span class="o">=</span> <span class="n">tx_params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">tx</span>

    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">export</span><span class="p">(),</span>
            <span class="s2">&quot;user_type&quot;</span><span class="p">:</span> <span class="s2">&quot;strategic_user&quot;</span><span class="p">,</span>
        <span class="p">}</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<hr>
<h2 id="Demand-generation">Demand generation<a class="anchor-link" href="#Demand-generation">&#182;</a></h2>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 7 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">generate_gbm_demand</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mean_ia_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">volatility</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">gbm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_gbm</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">volatility</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">apply_block_time_variance</span><span class="p">(</span><span class="n">gbm</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">mean_ia_time</span><span class="o">=</span><span class="n">mean_ia_time</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 8 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">generate_decaying_abm_demand</span><span class="p">(</span><span class="n">S0</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">duration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">volatility</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mean_ia_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">poisson_process</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">jp</span> <span class="o">=</span> <span class="n">jump_process</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">S0</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">discount</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="n">abm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_abm</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">volatility</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">apply_block_time_variance</span><span class="p">(</span><span class="n">abm</span> <span class="o">+</span> <span class="n">jp</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">mean_ia_time</span><span class="o">=</span><span class="n">mean_ia_time</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<hr>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 9 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">demand_scenario</span><span class="p">,</span> <span class="n">demand_id</span><span class="p">,</span> <span class="n">shares_scenario</span><span class="p">,</span> <span class="n">txpool</span><span class="p">,</span> <span class="n">extra_metrics</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Instantiate a couple of things</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">()</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">user_pool</span> <span class="o">=</span> <span class="n">UserPool</span><span class="p">()</span>
    <span class="n">max_basefee_window</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">block_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s2">&quot;MAX_GAS_EIP1559&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">constants</span><span class="p">[</span><span class="s2">&quot;SIMPLE_TRANSACTION_GAS&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    
    <span class="c1"># `env` is the &quot;environment&quot; of the simulation</span>
    <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;basefee&quot;</span><span class="p">:</span> <span class="n">constants</span><span class="p">[</span><span class="s2">&quot;INITIAL_BASEFEE&quot;</span><span class="p">],</span>
        <span class="s2">&quot;current_block&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;basefees&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">constants</span><span class="p">[</span><span class="s2">&quot;INITIAL_BASEFEE&quot;</span><span class="p">]],</span>
        <span class="s2">&quot;previous_gas_used&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># in percent</span>
        <span class="s2">&quot;previous_avg_tip&quot;</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">,</span>
        <span class="s2">&quot;wallet_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;posted&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">demand_scenario</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;simulation loop&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">demand_scenario</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">MAX_TX_POOL</span><span class="p">:</span>
            <span class="k">break</span>
        
        <span class="c1"># Sets current block</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;current_block&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        
        <span class="c1"># Reset the random number generator with new seed to generate users with same values across runs</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">((</span><span class="mi">2</span> <span class="o">**</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">**</span> <span class="n">demand_id</span><span class="p">))</span>
        
        <span class="c1">### SIMULATION ###</span>
        
        <span class="c1"># The transaction pool applies its eviction policy after basefee update</span>
        <span class="n">basefee_update_evicted_txs</span> <span class="o">=</span> <span class="n">txpool</span><span class="o">.</span><span class="n">purge_pool_after_basefee_update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="c1"># We return some demand which on expectation yields `demand_scenario[t]` new users per round</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">spawn_poisson_heterogeneous_demand</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">demand_scenario</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">shares_scenario</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
        
        <span class="c1"># Add new users to the pool</span>
        <span class="c1"># We query each new user with the current basefee value</span>
        <span class="c1"># Users either return a transaction or None if they prefer to balk</span>
        <span class="n">decided_txs</span> <span class="o">=</span> <span class="n">user_pool</span><span class="o">.</span><span class="n">decide_transactions</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        
        <span class="c1"># Divide incoming transactions between accepted and rejected ones</span>
        <span class="n">incoming_evicted_txs</span><span class="p">,</span> <span class="n">accepted_txs</span> <span class="o">=</span> <span class="n">txpool</span><span class="o">.</span><span class="n">apply_eviction_policy</span><span class="p">(</span><span class="n">decided_txs</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

        <span class="c1"># New transactions are added to the transaction pool</span>
        <span class="c1"># `evicted_txs` holds the transactions removed from the pool for lack of space</span>
        <span class="n">pool_limit_evicted_txs</span> <span class="o">=</span> <span class="n">txpool</span><span class="o">.</span><span class="n">add_txs</span><span class="p">(</span><span class="n">accepted_txs</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>

        <span class="c1"># The best valid transactions are taken out of the pool for inclusion</span>
        <span class="n">selected_txs</span> <span class="o">=</span> <span class="n">txpool</span><span class="o">.</span><span class="n">select_transactions</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span><span class="p">)</span>
        
        <span class="n">txpool</span><span class="o">.</span><span class="n">remove_txs</span><span class="p">([</span><span class="n">tx</span><span class="o">.</span><span class="n">tx_hash</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">selected_txs</span><span class="p">])</span>

        <span class="c1"># We create a block with these transactions</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">Block1559</span><span class="p">(</span>
            <span class="n">txs</span> <span class="o">=</span> <span class="n">selected_txs</span><span class="p">,</span> <span class="n">parent_hash</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">current_head</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">basefee</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># Record the gas used and avg tip in the block</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_gas_used&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">gas_used</span><span class="p">()</span> <span class="o">/</span> <span class="n">constants</span><span class="p">[</span><span class="s2">&quot;MAX_GAS_EIP1559&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_avg_tip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">average_tip</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;wallet_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;posted&quot;</span> <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_gas_used&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="k">else</span> <span class="s2">&quot;expert&quot;</span>
        
        <span class="c1"># The block is added to the chain</span>
        <span class="n">chain</span><span class="o">.</span><span class="n">add_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        
        <span class="c1">### METRICS ###</span>
        <span class="n">user_efficiency</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">user_pool</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">tx</span><span class="o">.</span><span class="n">sender</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">selected_txs</span><span class="p">])</span>
                
        <span class="n">row_metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;block&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
            <span class="s2">&quot;basefee_update_evictions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">basefee_update_evicted_txs</span><span class="p">),</span>
            <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">),</span>
            <span class="s2">&quot;decided_txs&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">decided_txs</span><span class="p">),</span>
            <span class="s2">&quot;incoming_evictions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">incoming_evicted_txs</span><span class="p">),</span>
            <span class="s2">&quot;pool_limit_evictions&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pool_limit_evicted_txs</span><span class="p">),</span>
            <span class="s2">&quot;included_txs&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_txs</span><span class="p">),</span>
            <span class="s2">&quot;basefee&quot;</span><span class="p">:</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="c1"># to Gwei</span>
            <span class="s2">&quot;gas_used&quot;</span><span class="p">:</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_gas_used&quot;</span><span class="p">],</span>
            <span class="s2">&quot;avg_tip&quot;</span><span class="p">:</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;previous_avg_tip&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
            <span class="s2">&quot;pool_length&quot;</span><span class="p">:</span> <span class="n">txpool</span><span class="o">.</span><span class="n">pool_length</span><span class="p">(),</span>
            <span class="s2">&quot;user_efficiency&quot;</span><span class="p">:</span> <span class="n">user_efficiency</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extra_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row_metrics</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">row_metrics</span><span class="p">,</span>
                <span class="o">**</span><span class="n">extra_metrics</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">user_pool</span><span class="p">,</span> <span class="n">txpool</span><span class="p">),</span>
            <span class="p">}</span>
        
        <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_metrics</span><span class="p">)</span>
        
        <span class="c1"># Finally, basefee is updated and a new round starts</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_basefee</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">])</span>
        <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefees&quot;</span><span class="p">][</span><span class="o">-</span><span class="p">(</span><span class="n">max_basefee_window</span><span class="o">-</span><span class="mi">1</span><span class="p">):]</span> <span class="o">+</span> <span class="p">[</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;basefee&quot;</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics</span><span class="p">),</span> <span class="n">user_pool</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>

<span class="n">volatilities</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="c1"># volatilities = [1.0]</span>
<span class="n">demand_paths</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">band_widths</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="c1"># band_widths = [0.0]</span>
<span class="n">blocks</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">run</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mi">76000</span>
<span class="n">mean_ia_time</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">max_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">blocks</span> <span class="o">*</span> <span class="n">mean_ia_time</span><span class="p">)</span>
<span class="n">max_txs_in_block</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s2">&quot;MAX_GAS_EIP1559&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
<span class="n">S0s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">max_txs_in_block</span> <span class="o">/</span> <span class="n">mean_ia_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>

<span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span>
    <span class="n">demand_paths</span><span class="p">,</span> <span class="n">volatilities</span><span class="p">,</span> <span class="n">band_widths</span><span class="p">,</span> <span class="n">S0s</span>
<span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;session loop&quot;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="p">(</span><span class="n">demand_path</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">band_width</span><span class="p">,</span> <span class="n">S0</span><span class="p">)</span> <span class="o">=</span> <span class="n">params</span>
    
    <span class="c1"># Generate demand</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">demand_path</span><span class="p">)</span>
    <span class="n">demand_scenario</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">generate_decaying_abm_demand</span><span class="p">(</span><span class="n">S0</span><span class="p">,</span> <span class="n">max_k</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">volatility</span><span class="p">,</span> <span class="n">mean_ia_time</span><span class="p">,</span> <span class="n">rng</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
   
    <span class="c1"># Shares of new users per time step</span>
    <span class="n">shares_scenario</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="n">StrategicUser</span><span class="p">:</span> <span class="mf">1.00</span><span class="p">,</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blocks</span><span class="p">)]</span>

    <span class="c1"># Transaction pool</span>
    <span class="n">txpool</span> <span class="o">=</span> <span class="n">TxPoolTrendPicker</span><span class="p">(</span><span class="n">band_width</span> <span class="o">=</span> <span class="n">band_width</span><span class="p">)</span>
    
    <span class="c1"># Simulate</span>
    <span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">user_pool</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">demand_scenario</span><span class="p">,</span> <span class="n">demand_path</span><span class="p">,</span> <span class="n">shares_scenario</span><span class="p">,</span> <span class="n">txpool</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;volatility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volatility</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;band_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_width</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;demand_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">demand_path</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S0</span>
    <span class="n">run</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">dfs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">df</span><span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div></div>







<div id="3f68b965-81ec-43a1-96a1-95d4ef2dc472" class="jupyter-widgets jp-OutputArea-output ">
<script type="text/javascript">
var element = document.getElementById('3f68b965-81ec-43a1-96a1-95d4ef2dc472');
</script>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script>
</div>

</div>

</div>

</div>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 10 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div></div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;../data/sim_runs.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>




    </div>
  </div>
  <script>
  // Authors
let authorData = ["barnabe"];
  </script>

  
</body>

  <div id="footer"></div>
    <script>
    ReactDOM.render(
      e(
        Footer, {
          acknowledgements: '',
        }
      ),
      document.querySelector("#footer")
    )

    const copyToClipboard = str => {
      const el = document.createElement("textarea") // Create a <textarea> element
      el.value = str // Set its value to the string that you want copied
      el.setAttribute("readonly", "") // Make it readonly to be tamper-proof
      el.style.position = "absolute"
      el.style.left = "-9999px" // Move outside the screen to make it invisible
      document.body.appendChild(el) // Append the <textarea> element to the HTML document
      const selected =
        document.getSelection().rangeCount > 0 // Check if there is any content selected previously
          ? document.getSelection().getRangeAt(0) // Store selection if found
          : false // Mark as false to know no selection existed before
      el.select() // Select the <textarea> content
      document.execCommand("copy") // Copy - only works as a result of a user action (e.g. click events)
      document.body.removeChild(el) // Remove the <textarea> element
      if (selected) {
        // If a selection existed before copying
        document.getSelection().removeAllRanges() // Unselect everything on the HTML document
        document.getSelection().addRange(selected) // Restore the original selection
      }
    }
    function handleCopyClick(evt) {
      // get the children of the parent element
      const { children } = evt.target.parentElement
      // grab the first element (we append the copy button on afterwards, so the first will be the code element)
      // destructure the innerText from the code block
      const { innerText } = Array.from(children)[0]
      // copy all of the code to the clipboard
      copyToClipboard(innerText)
    }

    const highlights = document.querySelectorAll(".jp-InputArea-editor .highlight")

    highlights.forEach(div => {
      // create the copy button
      const copy = document.createElement("button")
      copy.innerHTML = "Copy"
      // add the event listener to each click
      copy.addEventListener("click", handleCopyClick)
      // append the copy button to each code block
      div.append(copy)
    })
    </script>
  </div>
  <script src="https://ethereum.github.io/rig/static/authorFormatting.js"></script>
  <script src="https://ethereum.github.io/rig/static/sectionFormatting.js"></script>
  <script src="https://ethereum.github.io/rig/static/referencesFormatting.js"></script>







</html>
